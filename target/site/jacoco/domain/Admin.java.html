<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Admin.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">github-inti-demo</a> &gt; <a href="index.source.html" class="el_package">domain</a> &gt; <span class="el_source">Admin.java</span></div><h1>Admin.java</h1><pre class="source lang-java linenums">package domain;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;
import java.sql.*;
import java.util.Base64;

public class Admin extends User {

    // دالة للاتصال بالداتابيز (SQLite) - نسخة خاصة بـ Admin
    public static Connection connect() {
<span class="fc" id="L13">        String url = &quot;jdbc:sqlite:database.db&quot;;</span>
<span class="fc" id="L14">        Connection conn = null;</span>
        try {
<span class="fc" id="L16">            conn = DriverManager.getConnection(url);</span>
<span class="fc" id="L17">        } catch (SQLException e) {</span>
<span class="fc" id="L18">            System.out.println(e.getMessage());</span>
<span class="fc" id="L19">        }</span>
<span class="fc" id="L20">        return conn;</span>
    }

    // كتلة static لإنشاء جدول admins تلقائياً أول مرة
    static {
<span class="fc" id="L25">        Connection conn = connect();</span>
<span class="fc" id="L26">        String sql = &quot;CREATE TABLE IF NOT EXISTS admins (\n&quot;</span>
                + &quot; id integer PRIMARY KEY AUTOINCREMENT,\n&quot;
                + &quot; username text NOT NULL UNIQUE,\n&quot;
                + &quot; password_hash text NOT NULL,\n&quot;
                + &quot; salt text NOT NULL\n&quot;
                + &quot;);&quot;;
<span class="fc" id="L32">        try (Statement stmt = conn.createStatement()) {</span>
<span class="fc" id="L33">            stmt.execute(sql);</span>
<span class="fc" id="L34">            System.out.println(&quot;تم إنشاء جدول admins بنجاح.&quot;);</span>
<span class="nc" id="L35">        } catch (SQLException e) {</span>
<span class="nc" id="L36">            System.out.println(e.getMessage());</span>
<span class="fc" id="L37">        }</span>
<span class="fc" id="L38">    }</span>

    // دالة لتوليد salt عشوائي
    public static String generateSalt() {
<span class="fc" id="L42">        SecureRandom random = new SecureRandom();</span>
<span class="fc" id="L43">        byte[] salt = new byte[16];</span>
<span class="fc" id="L44">        random.nextBytes(salt);</span>
<span class="fc" id="L45">        return Base64.getEncoder().encodeToString(salt);</span>
    }

    // دالة لتشفير كلمة المرور باستخدام SHA-256 مع salt
    public static String hashPassword(String password, String salt) {
        try {
<span class="fc" id="L51">            MessageDigest md = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="fc" id="L52">            md.update(salt.getBytes());</span>
<span class="fc" id="L53">            byte[] hashedBytes = md.digest(password.getBytes());</span>
<span class="fc" id="L54">            return Base64.getEncoder().encodeToString(hashedBytes);</span>
<span class="fc" id="L55">        } catch (NoSuchAlgorithmException e) {</span>
<span class="fc" id="L56">            throw new RuntimeException(&quot;خطأ في الـ hashing: &quot; + e.getMessage());</span>
        }
    }

    // تسجيل أدمن جديد
    public static Admin register(String username, String password) {
<span class="fc" id="L62">        Connection conn = connect();</span>
<span class="fc" id="L63">        String checkSql = &quot;SELECT * FROM admins WHERE username = ?&quot;;</span>
<span class="fc" id="L64">        try (PreparedStatement pstmt = conn.prepareStatement(checkSql)) {</span>
<span class="fc" id="L65">            pstmt.setString(1, username);</span>
<span class="fc" id="L66">            ResultSet rs = pstmt.executeQuery();</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L68">                System.out.println(&quot;الأدمن موجود بالفعل: &quot; + username);</span>
<span class="fc" id="L69">                return null;</span>
            }
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        } catch (SQLException e) {</span>
<span class="fc" id="L72">            System.out.println(&quot;خطأ في التحقق: &quot; + e.getMessage());</span>
<span class="fc" id="L73">            return null;</span>
<span class="fc" id="L74">        }</span>

<span class="fc" id="L76">        String salt = generateSalt();</span>
<span class="fc" id="L77">        String passwordHash = hashPassword(password, salt);</span>

<span class="fc" id="L79">        String sql = &quot;INSERT INTO admins (username, password_hash, salt) VALUES (?, ?, ?)&quot;;</span>
<span class="fc" id="L80">        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L81">            pstmt.setString(1, username);</span>
<span class="fc" id="L82">            pstmt.setString(2, passwordHash);</span>
<span class="fc" id="L83">            pstmt.setString(3, salt);</span>
<span class="fc" id="L84">            pstmt.executeUpdate();</span>
<span class="fc" id="L85">            System.out.println(&quot;تم تسجيل الأدمن بنجاح: &quot; + username);</span>
<span class="fc" id="L86">            return new Admin(username, passwordHash, salt);</span>
<span class="fc" id="L87">        } catch (SQLException e) {</span>
<span class="fc" id="L88">            System.out.println(&quot;خطأ في التسجيل: &quot; + e.getMessage());</span>
<span class="fc" id="L89">            return null;</span>
        }
    }

    // constructor خاص
    public Admin(String username, String passwordHash, String salt) {
<span class="fc" id="L95">        super(username, passwordHash, salt);</span>
<span class="fc" id="L96">        this.setLoggedIn(false);</span>
<span class="fc" id="L97">    }</span>

    // تسجيل الدخول للأدمن
    public static Admin login(String username, String password) {
<span class="fc" id="L101">        Connection conn = connect();</span>
<span class="fc" id="L102">        String sql = &quot;SELECT password_hash, salt FROM admins WHERE username = ?&quot;;</span>
<span class="fc" id="L103">        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L104">            pstmt.setString(1, username);</span>
<span class="fc" id="L105">            ResultSet rs = pstmt.executeQuery();</span>

<span class="fc bfc" id="L107" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L108">                String storedHash = rs.getString(&quot;password_hash&quot;);</span>
<span class="fc" id="L109">                String salt = rs.getString(&quot;salt&quot;);</span>
<span class="fc" id="L110">                String inputHash = hashPassword(password, salt);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">                if (storedHash.equals(inputHash)) {</span>
<span class="fc" id="L112">                    Admin admin = new Admin(username, storedHash, salt);</span>
<span class="fc" id="L113">                    admin.setLoggedIn(true);</span>
<span class="fc" id="L114">                    return admin;</span>
                } else {
<span class="fc" id="L116">                    return null;</span>
                }
            } else {
<span class="fc" id="L119">                return null;</span>
            }
<span class="pc bpc" id="L121" title="2 of 4 branches missed.">        } catch (SQLException e) {</span>
<span class="fc" id="L122">            return null;</span>
        }
    }

    public void showAdminInfo() {
<span class="fc" id="L127">        System.out.println(&quot;Admin username: &quot; + getUsername());</span>
<span class="fc" id="L128">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>