<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Admin.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">github-inti-demo</a> &gt; <a href="index.source.html" class="el_package">domain</a> &gt; <span class="el_source">Admin.java</span></div><h1>Admin.java</h1><pre class="source lang-java linenums">package domain;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;
import java.sql.*;
import java.util.Base64;

public class Admin extends User {

    // دالة للاتصال بالداتابيز (SQLite) - نسخة خاصة بـ Admin
    private static Connection connect() {
<span class="nc" id="L13">        String url = &quot;jdbc:sqlite:database.db&quot;;  // نفس ملف الداتابيز</span>
<span class="nc" id="L14">        Connection conn = null;</span>
        try {
<span class="nc" id="L16">            conn = DriverManager.getConnection(url);</span>
<span class="nc" id="L17">        } catch (SQLException e) {</span>
<span class="nc" id="L18">            System.out.println(e.getMessage());</span>
<span class="nc" id="L19">        }</span>
<span class="nc" id="L20">        return conn;</span>
    }

    // كتلة static لإنشاء جدول admins تلقائياً أول مرة
    static {
<span class="nc" id="L25">        Connection conn = connect();</span>
<span class="nc" id="L26">        String sql = &quot;CREATE TABLE IF NOT EXISTS admins (\n&quot;</span>
                + &quot; id integer PRIMARY KEY AUTOINCREMENT,\n&quot;
                + &quot; username text NOT NULL UNIQUE,\n&quot;
                + &quot; password_hash text NOT NULL,\n&quot;
                + &quot; salt text NOT NULL\n&quot;
                + &quot;);&quot;;
<span class="nc" id="L32">        try (Statement stmt = conn.createStatement()) {</span>
<span class="nc" id="L33">            stmt.execute(sql);</span>
<span class="nc" id="L34">            System.out.println(&quot;تم إنشاء جدول admins بنجاح.&quot;);</span>
<span class="nc" id="L35">        } catch (SQLException e) {</span>
<span class="nc" id="L36">            System.out.println(e.getMessage());</span>
<span class="nc" id="L37">        }</span>
<span class="nc" id="L38">    }</span>

    // دالة لتوليد salt عشوائي (للأمان) - نسخة خاصة بـ Admin
    private static String generateSalt() {
<span class="nc" id="L42">        SecureRandom random = new SecureRandom();</span>
<span class="nc" id="L43">        byte[] salt = new byte[16];</span>
<span class="nc" id="L44">        random.nextBytes(salt);</span>
<span class="nc" id="L45">        return Base64.getEncoder().encodeToString(salt);</span>
    }

    // دالة لتشفير كلمة المرور باستخدام SHA-256 مع salt - نسخة خاصة بـ Admin
    private static String hashPassword(String password, String salt) {
        try {
<span class="nc" id="L51">            MessageDigest md = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="nc" id="L52">            md.update(salt.getBytes());</span>
<span class="nc" id="L53">            byte[] hashedBytes = md.digest(password.getBytes());</span>
<span class="nc" id="L54">            return Base64.getEncoder().encodeToString(hashedBytes);</span>
<span class="nc" id="L55">        } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L56">            throw new RuntimeException(&quot;خطأ في الـ hashing: &quot; + e.getMessage());</span>
        }
    }

    // دالة static لتسجيل أدمن جديد (Sign Up للأدمن)
    // ترجع Admin object إذا نجح، أو null إذا كان الأدمن موجود
    public static Admin register(String username, String password) {
        // تحقق إذا الأدمن موجود بالفعل
<span class="nc" id="L64">        Connection conn = connect();</span>
<span class="nc" id="L65">        String checkSql = &quot;SELECT * FROM admins WHERE username = ?&quot;;</span>
<span class="nc" id="L66">        try (PreparedStatement pstmt = conn.prepareStatement(checkSql)) {</span>
<span class="nc" id="L67">            pstmt.setString(1, username);</span>
<span class="nc" id="L68">            ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L70">                System.out.println(&quot;الأدمن موجود بالفعل: &quot; + username);</span>
<span class="nc" id="L71">                return null;  // فشل التسجيل</span>
            }
<span class="nc bnc" id="L73" title="All 2 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L74">            System.out.println(&quot;خطأ في التحقق: &quot; + e.getMessage());</span>
<span class="nc" id="L75">            return null;</span>
<span class="nc" id="L76">        }</span>

        // توليد salt و hashing
<span class="nc" id="L79">        String salt = generateSalt();</span>
<span class="nc" id="L80">        String passwordHash = hashPassword(password, salt);</span>

        // حفظ في الداتابيز (جدول admins)
<span class="nc" id="L83">        String sql = &quot;INSERT INTO admins (username, password_hash, salt) VALUES (?, ?, ?)&quot;;</span>
<span class="nc" id="L84">        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L85">            pstmt.setString(1, username);</span>
<span class="nc" id="L86">            pstmt.setString(2, passwordHash);</span>
<span class="nc" id="L87">            pstmt.setString(3, salt);</span>
<span class="nc" id="L88">            pstmt.executeUpdate();</span>
<span class="nc" id="L89">            System.out.println(&quot;تم تسجيل الأدمن بنجاح: &quot; + username);</span>
            // إرجاع كائن Admin جديد
<span class="nc" id="L91">            return new Admin(username, passwordHash, salt);</span>
<span class="nc" id="L92">        } catch (SQLException e) {</span>
<span class="nc" id="L93">            System.out.println(&quot;خطأ في التسجيل: &quot; + e.getMessage());</span>
<span class="nc" id="L94">            return null;</span>
        }
    }

    // constructor خاص (protected) للاستخدام الداخلي بعد الـ login
    protected Admin(String username, String passwordHash, String salt) {
<span class="nc" id="L100">        super(username, passwordHash, salt);</span>
<span class="nc" id="L101">        this.setLoggedIn(false);  // سيتم تحديثه في الـ login</span>
<span class="nc" id="L102">    }</span>

    // دالة static لتسجيل الدخول (Login للأدمن)
    // ترجع Admin object إذا نجح، أو null إذا فشل
    public static Admin login(String username, String password) {
<span class="nc" id="L107">        Connection conn = connect();</span>
<span class="nc" id="L108">        String sql = &quot;SELECT password_hash, salt FROM admins WHERE username = ?&quot;;</span>
<span class="nc" id="L109">        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L110">            pstmt.setString(1, username);</span>
<span class="nc" id="L111">            ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L114">                String storedHash = rs.getString(&quot;password_hash&quot;);</span>
<span class="nc" id="L115">                String salt = rs.getString(&quot;salt&quot;);</span>

                // hashing كلمة المرور المدخلة ومقارنتها
<span class="nc" id="L118">                String inputHash = hashPassword(password, salt);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (storedHash.equals(inputHash)) {</span>
<span class="nc" id="L120">                    System.out.println(&quot;Admin login successful, welcome &quot; + username + &quot;!&quot;);</span>
<span class="nc" id="L121">                    Admin admin = new Admin(username, storedHash, salt);</span>
<span class="nc" id="L122">                    admin.setLoggedIn(true);</span>
<span class="nc" id="L123">                    return admin;</span>
                } else {
<span class="nc" id="L125">                    System.out.println(&quot;Invalid username or password for admin.&quot;);</span>
<span class="nc" id="L126">                    return null;</span>
                }
            } else {
<span class="nc" id="L129">                System.out.println(&quot;الأدمن غير موجود.&quot;);</span>
<span class="nc" id="L130">                return null;</span>
            }
<span class="nc bnc" id="L132" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L133">            System.out.println(&quot;خطأ في الدخول: &quot; + e.getMessage());</span>
<span class="nc" id="L134">            return null;</span>
        }
    }

//    // Add a new book //
//    public void addBook(LibrarySystem library, String title, String author, String isbn) {
//        Book newBook = new Book(title, author, isbn);
//        library.addBook(newBook);
//        System.out.println(&quot;Admin &quot; + getUsername() + &quot; added book: &quot; + title);
//    }

    public void showAdminInfo() {
<span class="nc" id="L146">        System.out.println(&quot;Admin username: &quot; + getUsername());</span>
<span class="nc" id="L147">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>